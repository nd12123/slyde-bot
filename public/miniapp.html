<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slyde WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--tg-theme-hint-color, #c0c0c0);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }

    .card-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .card-text {
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
      line-height: 1.5;
    }

    input, button {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--tg-theme-hint-color, #c0c0c0);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 12px;
    }

    input {
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      color: var(--tg-theme-text-color, #000);
    }

    input::placeholder {
      color: var(--tg-theme-hint-color, #999);
    }

    button {
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }

    button:active {
      opacity: 0.8;
    }

    button.secondary {
      background: var(--tg-theme-hint-color, #ccc);
      color: var(--tg-theme-text-color, #000);
      margin-top: 8px;
    }

    .user-info {
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .user-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .user-info-label {
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
    }

    .user-info-value {
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--tg-theme-hint-color, #999);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--tg-theme-hint-color, #ccc);
      border-top-color: var(--tg-theme-button-color, #0088cc);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
      border-left: 4px solid #c33;
    }

    .success {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
      border-left: 4px solid #3c3;
    }

    footer {
      text-align: center;
      padding: 20px 0;
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
      border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      margin-top: auto;
    }

    .event-card {
      background: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .event-banner {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }

    .event-info {
      padding: 16px;
    }

    .event-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .event-detail {
      font-size: 13px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 4px;
    }

    .cta-button {
      position: sticky;
      bottom: 0;
      background: var(--tg-theme-bg-color, #ffffff);
      padding: 12px 16px;
      border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéâ Slyde</h1>
      <p class="subtitle">Telegram WebApp</p>
    </header>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen active">
      <div class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 12px;">Initializing...</p>
      </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="screen">
      <div class="card">
        <div class="card-title">‚úÖ Signed In</div>
        <div class="user-info">
          <div class="user-info-row">
            <span class="user-info-label">Telegram ID</span>
            <span class="user-info-value" id="userId">-</span>
          </div>
          <div class="user-info-row">
            <span class="user-info-label">Username</span>
            <span class="user-info-value" id="username">-</span>
          </div>
        </div>
      </div>

      <!-- CTA: Open native app -->
      <button id="openAppBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 16px; padding: 16px; cursor: pointer; border: none; color: white; border-radius: 6px; width: 100%;">üöÄ Open Slyde App</button>

      <!-- Navigation -->
      <button onclick="showScreen('eventsScreen')">üìÖ Browse Events</button>
      <button onclick="showScreen('referralScreen')" class="secondary">üë• Referrals</button>
      <button onclick="showScreen('feedbackScreen')" class="secondary">üí¨ Feedback</button>
    </div>

    <!-- Events Screen -->
    <div id="eventsScreen" class="screen">
      <button onclick="showScreen('authScreen')" class="secondary">‚Üê Back</button>
      <h2 style="margin: 20px 0 16px 0;">üìÖ Upcoming Events</h2>

      <div id="eventsContainer">
        <div class="loading">
          <div class="spinner"></div>
          <p style="margin-top: 12px;">Loading events...</p>
        </div>
      </div>
    </div>

    <!-- Event Preview Screen -->
    <div id="eventPreviewScreen" class="screen">
      <button onclick="showScreen('eventsScreen')" class="secondary">‚Üê Back</button>
      <div id="eventPreviewContainer"></div>
      <div class="cta-button">
        <button onclick="openApp('event')">üöÄ Open Slyde App</button>
      </div>
    </div>

    <!-- Referral Screen -->
    <div id="referralScreen" class="screen">
      <button onclick="showScreen('authScreen')" class="secondary">‚Üê Back</button>
      <h2 style="margin: 20px 0 16px 0;">üë• Invite Friends</h2>

      <div class="card">
        <div class="card-title">Your Referral Code</div>
        <div id="referralCode" style="font-family: monospace; font-weight: 600; font-size: 16px; margin-bottom: 12px;">-</div>
        <button onclick="copyReferralCode()">üìã Copy Code</button>
      </div>

      <div id="referralMessage" style="display: none;"></div>
    </div>

    <!-- Feedback Screen -->
    <div id="feedbackScreen" class="screen">
      <button onclick="showScreen('authScreen')" class="secondary">‚Üê Back</button>
      <h2 style="margin: 20px 0 16px 0;">üí¨ Send Feedback</h2>

      <div class="card">
        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 600;">Feedback Type</label>
        <select id="feedbackCategory" style="width: 100%; padding: 12px; border: 1px solid var(--tg-theme-hint-color, #c0c0c0); border-radius: 6px; margin-bottom: 12px; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000);">
          <option value="bug">üêõ Bug Report</option>
          <option value="idea">üí° Feature Idea</option>
          <option value="other">üí≠ Other</option>
        </select>

        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 600;">Message</label>
        <textarea id="feedbackMessage" placeholder="Tell us what you think..." style="width: 100%; padding: 12px; border: 1px solid var(--tg-theme-hint-color, #c0c0c0); border-radius: 6px; margin-bottom: 12px; background: var(--tg-theme-secondary-bg-color, #f5f5f5); color: var(--tg-theme-text-color, #000); font-family: inherit; resize: vertical; min-height: 100px;"></textarea>

        <button onclick="submitFeedback()">üì§ Submit</button>
      </div>

      <div id="feedbackMessage" style="display: none;"></div>
    </div>
  </div>

  <footer>
    Slyde WebApp v1.0 ‚Ä¢ Tap to continue

    <!-- Debug Panel -->
    <div id="debugPanel" style="position: fixed; bottom: 0; left: 0; right: 0; background: #000; color: #0f0; font-size: 10px; max-height: 100px; overflow-y: auto; padding: 8px; font-family: monospace; z-index: 9999; border-top: 1px solid #0f0; user-select: text;">
      <div style="text-align: right; margin-bottom: 4px;">
        <button onclick="copyDebugLogs()" style="background: #0f0; color: #000; border: none; padding: 2px 4px; cursor: pointer; font-size: 10px; margin-right: 4px;">üìã Copy</button>
        <button onclick="document.getElementById('debugPanel').style.display='none'" style="background: #0f0; color: #000; border: none; padding: 2px 4px; cursor: pointer; font-size: 10px;">‚úï</button>
      </div>
      <div id="debugLog" style="user-select: text; line-height: 1.3;"></div>
    </div>
  </footer>

  <script>
    // Override console.log to display in debug panel
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addToDebugPanel(message) {
      const debugLog = document.getElementById('debugLog');
      if (debugLog) {
        const line = document.createElement('div');
        line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
        debugLog.appendChild(line);
        debugLog.scrollTop = debugLog.scrollHeight;
        // Keep only last 50 lines
        while (debugLog.children.length > 50) {
          debugLog.removeChild(debugLog.firstChild);
        }
      }
    }

    function copyDebugLogs() {
      const debugLog = document.getElementById('debugLog');
      if (debugLog) {
        // Get all log lines and combine them
        const logs = Array.from(debugLog.children)
          .map(line => line.textContent)
          .join('\n');

        // Copy to clipboard
        navigator.clipboard.writeText(logs).then(() => {
          alert('‚úÖ Logs copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy logs:', err);
          // Fallback: use selection method
          const selection = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(debugLog);
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand('copy');
          alert('‚úÖ Logs copied to clipboard (fallback method)!');
        });
      }
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      addToDebugPanel(args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      addToDebugPanel('‚ùå ' + args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
    };

    console.warn = function(...args) {
      originalWarn.apply(console, args);
      addToDebugPanel('‚ö†Ô∏è ' + args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' '));
    };

    console.log('üü¢ Debug panel loaded');

    // Telegram WebApp SDK - Will be initialized when SDK is ready
    let tgApp = window.Telegram?.WebApp;

    // Wait for Telegram SDK to be ready
    function waitForTelegramSDK() {
      return new Promise((resolve) => {
        console.log('üì± [MiniApp] Waiting for Telegram SDK...');

        // Check if already loaded
        if (window.Telegram?.WebApp) {
          console.log('‚úÖ [MiniApp] Telegram SDK already loaded');
          tgApp = window.Telegram.WebApp;
          resolve();
          return;
        }

        // Wait for SDK to load with timeout
        let attempts = 0;
        const checkSDK = setInterval(() => {
          attempts++;
          if (window.Telegram?.WebApp) {
            console.log('‚úÖ [MiniApp] Telegram SDK loaded after', attempts, 'attempts');
            tgApp = window.Telegram.WebApp;
            clearInterval(checkSDK);
            resolve();
          } else if (attempts > 50) { // ~5 seconds timeout
            console.warn('‚ö†Ô∏è [MiniApp] Telegram SDK failed to load (timeout)');
            clearInterval(checkSDK);
            resolve(); // Still continue, might be in test environment
          }
        }, 100);
      });
    }

    // App state
    const state = {
      user: null,
      sessionToken: null,
    };

    // Initialize app
    async function init() {
      console.log('üì± [MiniApp] Initializing app...');

      // First, ensure Telegram SDK is ready
      await waitForTelegramSDK();

      // Check for test mode (direct browser testing)
      const testMode = new URLSearchParams(window.location.search).get('test');
      if (testMode === 'true' && !tgApp) {
        console.log('üì± [MiniApp] TEST MODE - Simulating Telegram user data');
        // Simulate a test user for development
        state.user = {
          app_user_id: 'tg_123456789',
          tg_id: 123456789,
          username: 'testuser',
        };
        console.log('‚úÖ [MiniApp] Test user loaded:', state.user);
        document.getElementById('userId').textContent = state.user.tg_id;
        document.getElementById('username').textContent = state.user.username;
        document.getElementById('referralCode').textContent = `REF_${state.user.tg_id}`;
        showScreen('authScreen');
        return;
      }

      if (!tgApp) {
        showError('Telegram WebApp SDK not available. Test locally with: ?test=true');
        return;
      }

      console.log('üì± [MiniApp] SDK is available, expanding...');

      // Expand WebApp
      tgApp.expand?.();
      tgApp.ready?.();  // Signal that WebApp is ready to display

      // Enable theme awareness
      if (tgApp.setHeaderColor) {
        tgApp.setHeaderColor('bg_color');
      }

      try {
        console.log('üì± [MiniApp] Starting auth...');
        console.log('üì± [MiniApp] tgApp available:', !!tgApp);
        console.log('üì± [MiniApp] tgApp.initData:', tgApp?.initData ? 'yes' : 'no');
        console.log('üì± [MiniApp] tgApp.initDataUnsafe:', !!tgApp?.initDataUnsafe);
        console.log('üì± [MiniApp] tgApp.initDataUnsafe.user:', !!tgApp?.initDataUnsafe?.user);

        // Try to get user data - multiple methods
        let user = null;

        // Method 1: initDataUnsafe (most reliable in WebApp)
        if (tgApp?.initDataUnsafe?.user) {
          user = tgApp.initDataUnsafe.user;
          console.log('‚úÖ [MiniApp] Got user from initDataUnsafe:', user);
        }
        // Method 2: Try initData parsing
        else if (tgApp?.initData) {
          console.log('üì± [MiniApp] Trying to parse initData...');
          const params = new URLSearchParams(tgApp.initData);
          const userStr = params.get('user');
          if (userStr) {
            user = JSON.parse(userStr);
            console.log('‚úÖ [MiniApp] Got user from initData parsing:', user);
          } else {
            console.log('‚ö†Ô∏è [MiniApp] No user in initData');
            console.log('üìã [MiniApp] Available params:', Array.from(params.keys()));
          }
        }
        // Method 3: Get from window if available
        else if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
          user = window.Telegram.WebApp.initDataUnsafe.user;
          console.log('‚úÖ [MiniApp] Got user from window.Telegram:', user);
        }

        if (!user) {
          console.error('‚ùå [MiniApp] No user data. Debug info:');
          console.error('  - tgApp:', tgApp);
          console.error('  - initDataUnsafe:', tgApp?.initDataUnsafe);
          console.error('  - initData:', tgApp?.initData);
          throw new Error('No user data available. Are you opening this from Telegram?');
        }

        console.log('üì± [MiniApp] User data:', user);

        // Create user session
        state.user = {
          app_user_id: `tg_${user.id}`,
          tg_id: user.id,
          username: user.username || user.first_name || `user_${user.id}`,
        };

        console.log('‚úÖ [MiniApp] Authenticated:', state.user);

        // Update UI
        document.getElementById('userId').textContent = state.user.tg_id;
        document.getElementById('username').textContent = state.user.username;

        // Generate referral code
        document.getElementById('referralCode').textContent = `REF_${state.user.tg_id}`;

        // Show auth screen
        showScreen('authScreen');

        // Hide back button on first screen
        tgApp.BackButton?.hide?.();
      } catch (error) {
        console.error('‚ùå [MiniApp] Init failed:', error);
        showError('Failed to initialize: ' + error.message);
      }
    }

    function showScreen(screenId) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });

      // Show target screen
      document.getElementById(screenId)?.classList.add('active');

      // Show back button for non-auth screens
      if (screenId !== 'authScreen') {
        tgApp?.BackButton?.show?.();
      } else {
        tgApp?.BackButton?.hide?.();
      }

      // Load screen-specific content
      if (screenId === 'eventsScreen') {
        loadEvents();
      }
    }

    async function loadEvents() {
      const container = document.getElementById('eventsContainer');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 12px;">Loading events...</p></div>';

      try {
        // Load sample events
        const events = [
          { id: 1, title: 'Slyde Night', date: '2025-11-10', attendees: '30+' },
          { id: 2, title: 'Networking Mixer', date: '2025-11-15', attendees: '50+' },
          { id: 3, title: 'VIP Party', date: '2025-11-20', attendees: '100+' },
        ];

        container.innerHTML = events.map(event => `
          <div class="event-card" onclick="viewEventPreview(${event.id})">
            <div class="event-banner">Banner Image</div>
            <div class="event-info">
              <div class="event-title">${event.title}</div>
              <div class="event-detail">üìÖ ${event.date}</div>
              <div class="event-detail">üë• ${event.attendees} going</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        container.innerHTML = `<div class="error">Failed to load events</div>`;
      }
    }

    async function viewEventPreview(eventId) {
      try {
        const response = await fetch(`/miniapp/events/preview?event_id=${eventId}`);
        const data = await response.json();

        if (!data.ok) throw new Error(data.error);

        const event = data.event;
        const preview = `
          <div class="event-card">
            <div class="event-banner">Banner</div>
            <div class="event-info">
              <div class="event-title">${event.title}</div>
              <div class="event-detail">üìÖ ${event.starts_at}</div>
              <div class="event-detail">üìç ${event.venue}</div>
              <div class="event-detail">üë• ${event.attendees_hint}</div>
            </div>
          </div>
        `;

        document.getElementById('eventPreviewContainer').innerHTML = preview;
        showScreen('eventPreviewScreen');
      } catch (error) {
        showError('Failed to load event: ' + error.message);
      }
    }

    function copyReferralCode() {
      const code = document.getElementById('referralCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showMessage('referral', '‚úÖ Code copied to clipboard!', 'success');
        tgApp?.HapticFeedback?.impactOccurred?.('light');
      });
    }

    async function submitFeedback() {
      const category = document.getElementById('feedbackCategory').value;
      const message = document.getElementById('feedbackMessage').value;

      if (!message.trim()) {
        showMessage('feedback', '‚ùå Please enter feedback', 'error');
        return;
      }

      try {
        const response = await fetch('/miniapp/feedback/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            category,
            message,
            tg_user_id: state.user.tg_id,
          }),
        });

        const data = await response.json();

        if (!data.ok) throw new Error(data.error);

        showMessage('feedback', `‚úÖ Feedback sent! Ticket: ${data.ticket_id}`, 'success');
        document.getElementById('feedbackMessage').value = '';
        tgApp?.HapticFeedback?.impactOccurred?.('light');
      } catch (error) {
        showMessage('feedback', '‚ùå Failed to submit: ' + error.message, 'error');
      }
    }

    function openNativeApp() {
      // Open app in Expo Go
      console.log('üöÄ [MiniApp] openNativeApp() called');
      console.log('üìä Current state.user:', state.user);

      if (!state.user) {
        console.error('‚ùå No user authenticated!');
        alert('User not authenticated');
        return;
      }

      console.log('‚úÖ User authenticated:', state.user);

      // Use Expo Tunnel - works from anywhere without local IP
      const tunnelUrl = 'exp://r8jail4-anonymous-8081.exp.direct';
      const deepLink = `${tunnelUrl}?tg_id=${state.user.tg_id}&username=${state.user.username}`;

      console.log('üîó Deep Link:', deepLink);

      // Create HTTPS redirect wrapper that Safari will open,
      // then Safari will be sent back to the exp:// deep link
      const encodedDeepLink = encodeURIComponent(deepLink);
      const redirectUrl = `${window.location.origin}/redirect.html?url=${encodedDeepLink}`;

      console.log('üîó Redirect URL:', redirectUrl);
      console.log('üîó Opening redirect page via tgApp.openLink...');

      if (tgApp?.openLink && typeof tgApp.openLink === 'function') {
        try {
          tgApp.openLink(redirectUrl);
          console.log('‚úÖ Opened redirect URL');
          return;
        } catch (e) {
          console.error('‚ùå tgApp.openLink failed:', e);
        }
      }

      // Fallback: direct attempt with window.location
      console.log('üîó Fallback: Direct navigation...');
      try {
        window.location.href = deepLink;
        console.log('‚úÖ Navigating to deep link');
        return;
      } catch (e) {
        console.error('‚ùå Navigation failed:', e);
      }

      // Last resort: copy to clipboard
      console.log('üìã Last resort: Copying to clipboard...');
      navigator.clipboard.writeText(deepLink).then(() => {
        console.log('‚úÖ Link copied to clipboard');
        alert('Deep link copied! Open Safari and paste:\n\n' + deepLink);
      }).catch(err => {
        console.error('‚ùå Failed to copy:', err);
        alert('Deep link:\n' + deepLink + '\n\nOpen in Safari');
      });
    }

    function openApp(context) {
      // In production, use Universal Link or deep link
      openNativeApp();
    }

    function showError(message) {
      const screen = document.getElementById('authScreen');
      const error = document.createElement('div');
      error.className = 'error';
      error.textContent = message;
      screen.insertBefore(error, screen.firstChild);
      showScreen('authScreen');
    }

    function showMessage(target, message, type) {
      const messageEl = document.getElementById(target + 'Message');
      messageEl.className = type;
      messageEl.textContent = message;
      messageEl.style.display = 'block';

      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }

    // Handle back button
    tgApp?.BackButton?.onClick?.(
      () => showScreen('authScreen')
    );

    // Start app - use proper Telegram SDK ready event
    function startApp() {
      console.log('üì± [MiniApp] Starting app...');
      if (window.Telegram?.WebApp?.onEvent) {
        // Proper way: wait for Telegram to be ready
        window.Telegram.WebApp.onEvent('viewportChanged', () => {
          console.log('üì± [MiniApp] Viewport changed, initializing...');
          init();
        });
      }

      // Also try direct load event as fallback
      window.addEventListener('load', init);

      // And try immediate init in case we're already loaded
      setTimeout(init, 100);
    }

    // Attach button click handler
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOMContentLoaded fired');
      const openAppBtn = document.getElementById('openAppBtn');
      console.log('üìå openAppBtn element:', openAppBtn);
      if (openAppBtn) {
        console.log('‚úÖ Found openAppBtn, attaching click listener...');
        openAppBtn.addEventListener('click', (e) => {
          console.log('üî¥ BUTTON CLICKED!');
          console.log('Event:', e);
          console.log('State user:', state.user);
          e.preventDefault();
          openNativeApp();
        });
      } else {
        console.error('‚ùå openAppBtn element NOT found!');
      }
    });

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', startApp);
    } else {
      startApp();
    }
  </script>
</body>
</html>
